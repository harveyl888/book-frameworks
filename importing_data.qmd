# Importing Data

## Introduction

Importing data is a fundemental step for a data processing framework.  It's also quite simple due to the many functions in base R and R packages available for importing.  In this chapter we'll explore how an R-based framework can be used to import data.

## A Simple Example

We will start with a simple example.  Our interpreter will simply read in data and print it to the console.  For the data we'll use the cricket dataset from TidyTuesday.

Our json input file will look like this:

```json
{
  "dataset": "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-11-30/matches.csv"
}
```

```{r}
#| echo: false
#| eval: true
jsonlite::write_json(list("dataset"="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-11-30/matches.csv"), 'data/myfile.json', auto_unbox = TRUE)
```

This file contains just a single parameter, `dataset`, pointing to the URL of the dataset to read.  Our interpreter has a very simple purpose - read in the file and send the output to the console.  Our interpreter looks as follows:

```{r}
#| message: false
#| eval: false
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
data <- readr::read_csv(inp$dataset)
print(data)
```

The output is:
```{r}
#| message: false
#| eval: true
#| echo: False
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
data <- readr::read_csv(inp$dataset)
print(data)
```

We have one parameter in our json file, `dataset`.  Changing it will change the dataset imported and printed.  Of course, if we had written an R script we could simply change the filename in the script itself or change a variable pointing to the script but using an external instruction file allows us to change the parameter without affecting the script itself.  For example, if we want chocolate ratings instead of cricket statistics we simply change the dataset parameter:

```json
{
  "dataset": "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"
}
```

```{r}
#| echo: false
#| eval: true
jsonlite::write_json(list("dataset"="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"), 'data/myfile.json', auto_unbox = TRUE)
```

Using the same interpreter outputs the following:

```{r}
#| eval: true
#| echo: False
#| message: false
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
data <- readr::read_csv(inp$dataset)
print(data)
```

Our interpreter (which is very simple) can be used to read in and display either dataset.  Later chapters will explore how we can use a single interpreter to perform data manipulation and graphing for a number of different data imports.

## Importing Different Data Formats

By introducing a conditional, an interpreter can import different data types.  

### Introducing a parameter to specify the file type

In the most simple approach we can add a parameter to specify the dataset type and then respond accordingly.  For example adding a `format` parameter to our instruction file and responding to its value:

```json
{
  "format": "csv",
  "dataset": "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"
}
```

```{r}
#| echo: false
#| eval: true
jsonlite::write_json(list("format"="csv", "dataset"="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"), 'data/myfile.json', auto_unbox = TRUE)
```

```{r}
#| message: false
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
if (isTRUE(inp$format == "csv")) {
  data <- readr::read_csv(inp$dataset)
} else if (isTRUE(inp$format == "sas")) {
  data <- haven::read_sas(inp$dataset)
} else {
  data <- NULL
}
print(data)
```

We have introduced a conditional that responds to the `format` parameter using {readr} to import the data if `format` is *csv* and {haven} to import the data if `format` is *sas*.  We also include a step to catch the fall-through if `format` is neither *csv* or *sas*.  
It is worth noting that `isTRUE` is used around the conditions.  This is because the input file may contain a record in which `format` has not been set.  In this case, once the json file is imported and converted to an R list, `inp$format` would be `NULL`.  and `inp$format == "csv"` equates to logical(0).  Wrapping the condition in `isTRUE` will still return a logical if part of the logical is NULL so if `inp$format` is `NULL`, `isTRUE(inp$format == "csv")` returns `FALSE`.

### The challenge of using dplyr::case_when()

An alternative, and more succinct approach, would be to use `case_when()` from {dplyr}:

```{r}
#| eval: false
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
data <- dplyr::case_when(
  isTRUE(inp$format == "csv") ~ readr::read_csv(inp$dataset),
  isTRUE(inp$format == "sas") ~ haven::read_sas(inp$dataset),
  TRUE ~ NULL
)
print(data)
```

Unfortunately, the code above results in an error as `case_when()` evaluates all right-hand side expressions prior to returning the output.  If the file is a CSV file, as is the case in this example, the expression `haven::read_sas(inp$dataset)` leads to an error and the `case_when()` expression fails.

### Deducing the file type from the file extension

Since the file format can generally be deduced from the file extension, we could even drop the dependence on the `format` parameter and build the condition on the file extension:

```{r}
#| echo: false
#| eval: true
jsonlite::write_json(list("dataset"="https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"), 'data/myfile.json', auto_unbox = TRUE)
```

```{r}
#| message: false
inp <- jsonlite::fromJSON("data/myfile.json", simplifyVector = FALSE)
if (isTRUE(tools::file_ext(inp$dataset) == "csv")) {
  data <- readr::read_csv(inp$dataset)
} else if (isTRUE(tools::file_ext(inp$dataset) == "sas")) {
  data <- haven::read_sas(inp$dataset)
} else {
  data <- NULL
}
print(data)
```

Thus, our instruction file could revert back to the shorter version in which the file type is not specified:

```json
{
  "dataset": "https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2022/2022-01-18/chocolate.csv"
}
```

